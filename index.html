<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A web interface for MQTT over Websockets">

    <title>Моніторинг водонапорних башт та КНС</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <!-- jQuery -->
    <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
    <!-- jgPlot -->
    <link class="include" rel="stylesheet" type="text/css" href="dist/jquery.jqplot.min.css" />
    <script type="text/javascript" src="js/jquery.jqplot.min.js"></script>
    <script type="text/javascript" src="js/jqplot.canvasTextRenderer.min.js"></script>
    <script type="text/javascript" src="js/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script type="text/javascript" src="js/jqplot.dateAxisRenderer.min.js"></script>
    <!-- MQTT Websocket -->
    <script type="text/javascript" src="js/mqttws31.js"></script>
    
<script type="text/javascript">
var host = '127.0.0.1';
var port = 9001;
var topic= 'wt2/#';
var useTLS = false;
var cleansession = true;
var mqtt;
var reconnectTimeout = 2000;
var pressure = new Array();

function MQTTconnect() {
    if (typeof path == "undefined") {
        path = '/mqtt';
    }
    mqtt = new Paho.MQTT.Client(
            host,
            port,
            path,
            "mqtt_panel" + parseInt(Math.random() * 100, 10)
    );
    var options = {
        timeout: 3,
        useSSL: useTLS,
        cleanSession: cleansession,
        onSuccess: onConnect,
        onFailure: function (message) {
            $('#status').html("Connection failed: " + message.errorMessage + "Retrying...");
            setTimeout(MQTTconnect, reconnectTimeout);
        }
    };

    mqtt.onConnectionLost = onConnectionLost;
    mqtt.onMessageArrived = onMessageArrived;
    console.log("Host: "+ host + ", Port: " + port + ", Path: " + path + " TLS: " + useTLS);
    mqtt.connect(options);
};

function onConnect() {
    $('#status').html('Connected to ' + host + ':' + port + path);
    mqtt.subscribe(topic, {qos: 0});
    $('#topic').html(topic);
};

function onConnectionLost(response) {
    setTimeout(MQTTconnect, reconnectTimeout);
    $('#status').html("Connection lost: " + responseObject.errorMessage + ". Reconnecting...");
};

function onMessageArrived(message) {
    var topic = message.destinationName;
    var payload = message.payloadString;
    console.log("Topic: " + topic + ", Message payload: " + payload); //debug
    $('#message').html(topic + ', ' + payload);
    var message = topic.split('/');
    var type = message[1];
    var device = message[2];

    var timestamp = new Date().getTime(); //Unix timestamp in ms

    if (type == 'alarm' && device == 'ExtPwr') {
        $('#alarm_extpwr').html('(value: ' + payload + ')');
        if (payload != 'on') {
            $('#label_extpwr').text('Відсутнє');
            $('#label_extpwr').removeClass('label-success').addClass('label-danger');
        } else {
            $('#label_extpwr').text('Наявне');
            $('#label_extpwr').removeClass('label-danger').addClass('label-success');
        }
    }
    else if (type == 'status' && device == 'Pump1') {
        $('#pump1').html('(value: ' + payload + ')');
        if (payload != 'on') {
            $('#label1').text('Вимкнений');
            $('#label1').removeClass('label-success').addClass('label-danger');
        } else {
            $('#label1').text('Працює');
            $('#label1').removeClass('label-danger').addClass('label-success');
        }
    }
    else if (type == 'status' && device == 'Pump2') {
        $('#pump2').html('(value: ' + payload + ')');
        if (payload != 'on') {
            $('#label2').text('Вимкнений');
            $('#label2').removeClass('label-success').addClass('label-danger');
        } else {
            $('#label2').text('Працює');
            $('#label2').removeClass('label-danger').addClass('label-success');
        }
    }
    else if (type == 'online') {
        //TODO inform about online/offline status
    }
    else if (type == 'set') {
        //TODO set pump switches to correct state at page loading
    }
    else {
        switch (type) {
        case 'pressure':
            $('#pressureSensor').html('(value: ' + payload + ')');
            $('#pressureLabel').text(payload);
            $('#pressureLabel').removeClass('').addClass('label-default');

            var entry = new Array();
            entry.push(timestamp);
            entry.push(parseFloat(payload));
            pressure.push(entry);
            if (pressure.length >= 120) { //shift old data
                pressure.shift()
            }

            $('#pressureChart').empty();
            var pressurePlot = $.jqplot ('pressureChart', [pressure], {
                axesDefaults: {
                    labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                    /*tickOptions: {
                        showMark: false,
                        showGridline: false,
                        show: false,
                        showLabel: false,
                    }*/
                  },
                grid: {
                    gridLineColor: '#FFFFFF',
                    borderWidth: 0,
                    shadow: false,
                },
                seriesDefaults: {
                    rendererOptions: {
                        smooth: true
                    },
                    showMarker: false,
                    lineWidth: 2,
                  },
                  axes: {
                    xaxis: {
                      renderer:$.jqplot.DateAxisRenderer,
                      tickRenderer: $.jqplot.CanvasAxisTickRenderer,
                      tickOptions: {formatString:'%H:%M:%S'},
                      pad: 0
                    },
                    yaxis: {
                        min: 0
                    }
                }
            });
            break;

        default: console.log('Error: Data do not match the MQTT topic.');
            break;
        }
    }
};

$(document).ready(function() {
    MQTTconnect();
	$('#check_remctrl').change(function () {
		mqtt.send('wt2/set/RemCtrl', $('#check_remctrl').is(":checked") ? 'on' : 'off', 1, true);
		if ($('#check_remctrl').is(":checked")) {
			$('#check_pump1').removeAttr("disabled");
			$('#check_pump2').removeAttr("disabled");
		} else {
			$('#check_pump1').attr("disabled", true);
			$('#check_pump2').attr("disabled", true);
		}
	});
	$('#check_pump1').change(function () {
		mqtt.send('wt2/set/Pump1', $('#check_pump1').is(":checked") ? 'on' : 'off', 1, true);
	});
	$('#check_pump2').change(function () {
		mqtt.send('wt2/set/Pump2', $('#check_pump2').is(":checked") ? 'on' : 'off', 1, true);
	});
});
</script>

  </head>

  <body>
    <div id="wrap">
      <div class="container">
        <div class="page-header"><h2><b>Моніторинг башти</b></h2></div>
		<div class="panel panel-default">
		  <div class="panel-body">
			<table class="table table-striped">
			<tr>
				<td colspan="3" style="vertical-align:middle;">
					<div class="col-md-6">
					  <label for="check_remctrl">Дистанційне керування</label>
					  <input type="checkbox" name="check_remctrl" id="check_remctrl">
					</div>
					<div class="col-md-3">
					  <label for="check_pump1">Насос 1</label>
					  <input type="checkbox" name="check_pump1" id="check_pump1">
					</div>
					<div class="col-md-3">
					  <label for="check_pump2">Насос 2</label>
					  <input type="checkbox" name="check_pump2" id="check_pump2">
					</div>
				</td>
			</tr>
			<tr>
				<td width="40%" style="vertical-align:middle;">
					<h4>Зовнішнє живлення</h4>
					<small style="display:none" id="alarm_extpwr">(no value recieved)</small>
				</td>
				<td width="0%" style="vertical-align:middle;"></td>
				<td style="vertical-align:middle;">
					<h4>&nbsp;<span id="label_extpwr" class="label">Unknown</span></h4>
				</td>
			</tr>
			<tr>
				<td width="40%" style="vertical-align:middle;">
					<h4>Насос 1</h4>
					<small style="display:none" id="pump1">(no value recieved)</small>
				</td>
				<td style="vertical-align:middle;"></td>
				<td style="vertical-align:middle;"><h4>&nbsp;<span id="label1" class="label">Unknown</span></h4></td>
			</tr>
			<tr>
				<td width="40%" style="vertical-align:middle;">
					<h4>Насос 2</h4>
					<small style="display:none" id="pump2">(no value recieved)</small>
				</td>
				<td style="vertical-align:middle;"></td>
				<td width="30%" style="vertical-align:middle;"><h4>&nbsp;<span id="label2" class="label">Unknown</span></h4></td>
			</tr>
			<tr>
				<td width="40%" style="vertical-align:middle;">
					<h4>Тиск у системі</h4>
					<small style="display:none" id="pressureSensor">(no value recieved)</small>
				</td>
				<td style="vertical-align:middle;"></td>
				<td width="30%" style="vertical-align:middle;"><h4>&nbsp;<span id="pressureLabel" class="label">Unknown</span></h4></td>
			</tr>
			<tr>
				<td colspan="3" style="vertical-align:middle;">
				  <div id="pressureChart" style="height:180px; width:400px;"></div>
				</td>
			</tr>
			</table>
		  </div>
		</div>
		<div class="panel panel-default">
		  <div class="panel-body">
			  <div class="row">
				<div class="col-md-6"><b>Останнє повідомлення:  </b> <small id="message">no message recieved</small></div>
				<div class="col-md-6"><b>Status: </b>  <small id='status'></small></div>
				<div class="col-md-6"><b>Topic: </b>  <small id='topic'></small></div>
			  </div>
		  </div>
		</div>
		<div class="footer">
		  <small><p class="text-center">&copy; <a href="">z80x1</a> 2018</p></small>
		</div>
	  </div>
	</div>
  </body>
</html>
