<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A web interface for MQTT over Websockets">

    <title>Моніторинг водонапорних башт та КНС</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <!-- jQuery -->
    <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
    <!-- Sparkline -->
    <script type="text/javascript" src="js/jquery.sparkline.min.js"></script>
    <!-- jgPlot -->
    <link class="include" rel="stylesheet" type="text/css" href="dist/jquery.jqplot.min.css" />
    <script type="text/javascript" src="js/jquery.jqplot.min.js"></script>
    <script type="text/javascript" src="js/jqplot.canvasTextRenderer.min.js"></script>
    <script type="text/javascript" src="js/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script type="text/javascript" src="js/jqplot.dateAxisRenderer.min.js"></script>
    <!-- MQTT Websocket -->
    <script type="text/javascript" src="js/mqttws31.js"></script>
    
<script type="text/javascript">
var host = '127.0.0.1';
var port = 9001;
var topic_alarm = 'wt2/alarm/+';
var topic_status = 'wt2/status/+';
var topic_pressure = 'wt2/pressure';
var useTLS = false;
var cleansession = true;
var mqtt;
var reconnectTimeout = 2000;
var pressure = new Array();

function MQTTconnect() {
    if (typeof path == "undefined") {
        path = '/mqtt';
    }
    mqtt = new Paho.MQTT.Client(
            host,
            port,
            path,
            "mqtt_panel" + parseInt(Math.random() * 100, 10)
    );
    var options = {
        timeout: 3,
        useSSL: useTLS,
        cleanSession: cleansession,
        onSuccess: onConnect,
        onFailure: function (message) {
            $('#status').html("Connection failed: " + message.errorMessage + "Retrying...");
            setTimeout(MQTTconnect, reconnectTimeout);
        }
    };

    mqtt.onConnectionLost = onConnectionLost;
    mqtt.onMessageArrived = onMessageArrived;
    console.log("Host: "+ host + ", Port: " + port + ", Path: " + path + " TLS: " + useTLS);
    mqtt.connect(options);
};

function onConnect() {
    $('#status').html('Connected to ' + host + ':' + port + path);
    mqtt.subscribe(topic_alarm, {qos: 0});
    mqtt.subscribe(topic_status, {qos: 0});
    mqtt.subscribe(topic_pressure, {qos: 0});
    $('#topic').html(topic_status);
};

function onConnectionLost(response) {
    setTimeout(MQTTconnect, reconnectTimeout);
    $('#status').html("Connection lost: " + responseObject.errorMessage + ". Reconnecting...");
};

function onMessageArrived(message) {
    var topic = message.destinationName;
    var payload = message.payloadString;
    console.log("Topic: " + topic + ", Message payload: " + payload); //debug
    $('#message').html(topic + ', ' + payload);
    var message = topic.split('/');
    var type = message[1];
    var device = message[2];

    var timestamp = new Date().getTime(); //Unix timestamp in ms

    if (type == 'alarm' && device == 'ExtPwr') {
        $('#alarm_extpwr').html('(value: ' + payload + ')');
        if (payload != 'on') {
            $('#label_extpwr').text('Відсутнє');
            $('#label_extpwr').removeClass('label-success').addClass('label-danger');
        } else {
            $('#label_extpwr').text('Наявне');
            $('#label_extpwr').removeClass('label-danger').addClass('label-success');
        }
    }
    if (type == 'status' && device == 'Pump1') {
        $('#pump1').html('(value: ' + payload + ')');
        if (payload != 'on') {
            $('#label1').text('Вимкнений');
            $('#label1').removeClass('label-success').addClass('label-danger');
        } else {
            $('#label1').text('Працює');
            $('#label1').removeClass('label-danger').addClass('label-success');
        }
    }
    if (type == 'status' && device == 'Pump2') {
        $('#pump2').html('(value: ' + payload + ')');
        if (payload != 'on') {
            $('#label2').text('Вимкнений');
            $('#label2').removeClass('label-success').addClass('label-danger');
        } else {
            $('#label2').text('Працює');
            $('#label2').removeClass('label-danger').addClass('label-success');
        }
    }


    switch (type) {
    case 'pressure':
        $('#pressureSensor').html('(value: ' + payload + ')');
        $('#pressureLabel').text(payload);
        $('#pressureLabel').removeClass('').addClass('label-default');

        var entry = new Array();
        entry.push(timestamp);
        entry.push(parseFloat(payload));
        pressure.push(entry);
        if (pressure.length >= 120) { //shift old data
            pressure.shift()
        }

        $('#pressureChart').empty();
        var pressurePlot = $.jqplot ('pressureChart', [pressure], {
            axesDefaults: {
                labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                /*tickOptions: {
                    showMark: false,
                    showGridline: false,
                    show: false,
                    showLabel: false,
                }*/
              },
            grid: {
                gridLineColor: '#FFFFFF',
                borderWidth: 0,
                shadow: false,
            },
            seriesDefaults: {
                rendererOptions: {
                    smooth: true
                },
                showMarker: false,
                lineWidth: 2,
              },
              axes: {
                xaxis: {
                  renderer:$.jqplot.DateAxisRenderer,
                  tickRenderer: $.jqplot.CanvasAxisTickRenderer,
                  tickOptions: {formatString:'%H:%M:%S'},
                  pad: 0
                },
                yaxis: {
                    min: 0
                }
            }
        });
        break;

    default: console.log('Error: Data do not match the MQTT topic.');
        break;
    }
};

$(document).ready(function() {
    MQTTconnect();
});
</script>

  </head>

  <body>
    <div id="wrap">
      <div class="container">
        <div class="page-header"><h1><b>Моніторинг башти</b></h1></div>

            <div class="panel panel-default">
              <div class="panel-body">
                    <table class="table table-striped">
                    <tr>
                        <td width="40%" style="vertical-align:middle;"><h3>Зовнішнє живлення</h3><small id="alarm_extpwr">(no value recieved)</small></td>
                        <td style="vertical-align:middle;"></td>
                        <td width="30%" style="vertical-align:middle;"><h4>&nbsp;<span id="label_extpwr" class="label">Unknown</span></h4></td>
                    </tr>
                    <tr>
                        <td width="40%" style="vertical-align:middle;"><h3>Насос 1</h3><small id="pump1">(no value recieved)</small></td>
                        <td style="vertical-align:middle;"></td>
                        <td width="30%" style="vertical-align:middle;"><h4>&nbsp;<span id="label1" class="label">Unknown</span></h4></td>
                    </tr>
                    <tr>
                        <td width="40%" style="vertical-align:middle;"><h3>Насос 2</h3><small id="pump2">(no value recieved)</small></td>
                        <td style="vertical-align:middle;"></td>
                        <td width="30%" style="vertical-align:middle;"><h4>&nbsp;<span id="label2" class="label">Unknown</span></h4></td>
                    </tr>
                    <tr>
                        <td width="40%" style="vertical-align:middle;"><h3>Тиск у системі</h3><small id="pressureSensor">(no value recieved)</small></td>
                        <td style="vertical-align:middle;"><div id="pressureChart" style="height:280px; width:480px;"></div></td>
                        <td width="30%" style="vertical-align:middle;"><h4>&nbsp;<span id="pressureLabel" class="label">Unknown</span></h4></td>
                    </tr>

                    </table>
              </div>
            </div>
        <div class="panel panel-default">
          <div class="panel-body">
              <div class="row">
                <div class="col-md-6"><b>Останнє повідомлення:  </b> <small id="message">no message recieved</small></div>
                <div class="col-md-6"><b>Status: </b>  <small id='status'></small></div>
                <div class="col-md-6"><b>Topic: </b>  <small id='topic'></small></div>
              </div>
          </div>
        </div>
      <div class="footer">
        <small><p class="text-center">&copy; <a href="http://affolter-engineering.ch">Affolter Engineering</a> 2013 - 2017</p></small>
    </div>
  </body>
</html>
